<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Local</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .balance-positive {
            color: #16a34a; /* green-600 */
        }
        .balance-negative {
            color: #dc2626; /* red-600 */
        }
        .transaction-income {
            color: #15803d; /* green-700 */
        }
        .transaction-expense {
            color: #b91c1c; /* red-700 */
        }
        /* Simple modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        /* Estilo para o item arrastável */
        .dragging {
            opacity: 0.5;
            border: 2px dashed #000;
        }
        /* Estilo para transações marcadas como realizadas */
        .transaction-done {
            background-color: #dbeafe !important; /* blue-100, usando !important para garantir a sobreposição */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Controle Financeiro</h1>
            <p class="text-gray-600 mt-2">Seus dados são salvos localmente no seu navegador.</p>
        </header>

        <!-- Balance Display -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 text-center">
            <h2 class="text-lg font-semibold text-gray-500 uppercase">Saldo Atual</h2>
            <p id="balance" class="text-4xl font-bold mt-2">R$ 0,00</p>
        </div>
        
        <!-- Add Transaction Form -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
            <h3 class="text-xl font-bold mb-6">Adicionar Nova Transação</h3>
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                    <input type="date" id="date" name="date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <input type="text" id="description" name="description" placeholder="Ex: Salário, Aluguel" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                        <input type="number" id="amount" name="amount" step="0.01" placeholder="0,00" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                     <div>
                        <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                        <select id="type" name="type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                            <option value="income">Receita</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 shadow-md h-10">Adicionar</button>
            </form>
        </div>

        <!-- Transactions List -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
             <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h3 class="text-xl font-bold">Histórico de Transações</h3>
                <div class="flex flex-wrap gap-2 items-center">
                    <div>
                        <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-1">Filtrar a partir de</label>
                        <input type="date" id="filter-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="import-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 text-sm h-10 mt-auto"><i class="fas fa-upload mr-2"></i>Importar</button>
                    <button id="export-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300 text-sm h-10 mt-auto"><i class="fas fa-download mr-2"></i>Exportar</button>
                    <input type="file" id="import-file" class="hidden" accept=".json">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Acumulado</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                       <!-- Rows will be inserted here by JavaScript -->
                       <tr>
                           <td colspan="5" class="text-center py-8 text-gray-500" id="empty-state">Nenhuma transação adicionada ainda.</td>
                       </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-xl">
            <h3 class="text-lg font-bold mb-4">Confirmar Exclusão</h3>
            <p class="text-gray-600 mb-6">Você tem certeza que deseja excluir esta transação?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="edit-transaction-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-xl text-left">
            <h3 class="text-lg font-bold mb-4">Editar Transação</h3>
            <form id="edit-transaction-form" class="grid grid-cols-1 gap-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label for="edit-date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                    <input type="date" id="edit-date" name="date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <input type="text" id="edit-description" name="description" placeholder="Ex: Salário, Aluguel" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                    <input type="number" id="edit-amount" name="amount" step="0.01" placeholder="0,00" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="edit-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                    <select id="edit-type" name="type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                        <option value="income">Receita</option>
                        <option value="expense">Despesa</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const DB_NAME = 'FinanceDB';
        const STORE_NAME = 'transactions';
        let db;

        // Função para inicializar o IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('date', 'date', { unique: false });
                        // Não precisamos de um índice 'order' se vamos ordenar em memória
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Banco de dados aberto com sucesso.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('Erro ao abrir o banco de dados:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Elementos do DOM
        const form = document.getElementById('transaction-form');
        const transactionList = document.getElementById('transaction-list');
        const balanceEl = document.getElementById('balance');
        const emptyStateEl = document.getElementById('empty-state');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file');
        const filterDateInput = document.getElementById('filter-date'); // Novo elemento de filtro

        // Elementos do modal de edição
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const editIdInput = document.getElementById('edit-id');
        const editDateInput = document.getElementById('edit-date');
        const editDescriptionInput = document.getElementById('edit-description');
        const editAmountInput = document.getElementById('edit-amount');
        const editTypeSelect = document.getElementById('edit-type');
        const cancelEditBtn = document.getElementById('cancel-edit');


        let transactionToDeleteId = null;
        let draggedItem = null; // Variável para armazenar o item sendo arrastado (para feedback visual)

        // Funções de formatação
        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };
        
        // CRUD com IndexedDB
        function addTransaction(transaction) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                // Atribui uma propriedade 'order' inicial para novas transações e 'isDone' como false
                const transactionToAdd = { ...transaction, order: Date.now(), isDone: false }; 
                const request = store.add(transactionToAdd);
                request.onsuccess = resolve;
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getAllTransactions() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function deleteTransaction(id) {
             return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = resolve;
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // Função para atualizar uma transação no IndexedDB
        function updateTransaction(transaction) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.put(transaction); // put() para atualizar ou adicionar
                request.onsuccess = resolve;
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // Função para atualizar a ordem das transações no banco de dados
        async function updateTransactionOrder(reorderedTransactions) {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);

            try {
                // Atualiza a propriedade 'order' para cada transação no banco de dados
                for (let i = 0; i < reorderedTransactions.length; i++) {
                    // Atribui uma nova ordem sequencial (índice no array)
                    const transaction = { ...reorderedTransactions[i], order: i }; 
                    await new Promise((resolve, reject) => {
                        const putRequest = store.put(transaction); // Usa put para atualizar registros existentes
                        putRequest.onsuccess = () => resolve();
                        putRequest.onerror = (event) => reject(event.target.error);
                    });
                }

                // Aguarda a conclusão da transação
                await new Promise((resolve, reject) => {
                    tx.oncomplete = () => resolve();
                    tx.onerror = (event) => reject(event.target.error);
                });

                await renderUI(); // Renderiza a UI novamente após a atualização completa
            } catch (error) {
                console.error('Erro ao atualizar a ordem das transações:', error);
                tx.abort(); // Aborta a transação em caso de erro
                throw error;
            }
        }

        // Função para alternar o status 'isDone' de uma transação
        async function toggleDoneStatus(id) {
            let allTransactions = await getAllTransactions();
            const transactionToToggle = allTransactions.find(t => t.id === id);

            if (transactionToToggle) {
                transactionToToggle.isDone = !transactionToToggle.isDone; // Alterna o status
                await updateTransaction(transactionToToggle);
                await renderUI();
            } else {
                showCustomModal("Erro: Transação não encontrada para alternar status.");
            }
        }


        // Renderização
        async function renderUI() {
            let allTransactions = await getAllTransactions(); // Obtenha todas as transações

            // Ordena TODAS as transações por data, e em seguida pela propriedade 'order'
            const sortedAllTransactions = allTransactions.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA - dateB !== 0) {
                    return dateA - dateB;
                }
                // Se as datas forem iguais, ordena pela propriedade 'order'
                // Assume 0 se 'order' for indefinido (para transações antigas sem a propriedade)
                return (a.order || 0) - (b.order || 0);
            });

            let cumulativeBalanceForAll = 0;
            const transactionsWithCumulative = sortedAllTransactions.map(transaction => {
                const amount = transaction.type === 'income' ? transaction.amount : -transaction.amount;
                cumulativeBalanceForAll += amount;
                return { ...transaction, cumulativeBalance: cumulativeBalanceForAll }; // Adiciona o saldo acumulado
            });

            const filterDateValue = filterDateInput.value;
            // Aplica o filtro de data nas transações já com o saldo acumulado
            let filteredAndSortedTransactions = transactionsWithCumulative;
            if (filterDateValue) {
                filteredAndSortedTransactions = transactionsWithCumulative.filter(transaction => {
                    return new Date(transaction.date) >= new Date(filterDateValue);
                });
            }
            
            transactionList.innerHTML = '';
            if (filteredAndSortedTransactions.length === 0) {
                emptyStateEl.style.display = 'table-row';
                emptyStateEl.setAttribute('colspan', '5'); // Atualiza o colspan
                balanceEl.textContent = formatCurrency(0);
                balanceEl.classList.remove('balance-negative');
                balanceEl.classList.add('balance-positive');
                return;
            }
            emptyStateEl.style.display = 'none';

            filteredAndSortedTransactions.forEach(transaction => {
                const amount = transaction.type === 'income' ? transaction.amount : -transaction.amount;
                const tr = document.createElement('tr');
                
                // Adiciona classes para tipo de transação. Se estiver 'done', remove as outras cores de fundo.
                if (transaction.isDone) {
                    tr.classList.add('transaction-done');
                } else {
                    tr.classList.add(transaction.type === 'income' ? 'bg-green-50' : 'bg-red-50');
                }

                const valueClass = transaction.type === 'income' ? 'transaction-income' : 'transaction-expense';
                
                // Adiciona atributos draggable e data-id
                tr.setAttribute('draggable', 'true');
                tr.setAttribute('data-id', transaction.id);

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(transaction.date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold ${valueClass}">${formatCurrency(amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold ${transaction.cumulativeBalance >= 0 ? 'balance-positive' : 'balance-negative'}">${formatCurrency(transaction.cumulativeBalance)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <button data-id="${transaction.id}" class="mark-done-btn text-gray-400 hover:${transaction.isDone ? 'text-gray-600' : 'text-blue-500'} transition duration-150 mr-2">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        <button data-id="${transaction.id}" class="edit-btn text-gray-400 hover:text-blue-600 transition duration-150 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button data-id="${transaction.id}" class="delete-btn text-gray-400 hover:text-red-600 transition duration-150">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                transactionList.appendChild(tr);
            });

            // O saldo total exibido no header é o último saldo acumulado de TODAS as transações
            const finalTotalBalance = transactionsWithCumulative.length > 0 ? 
                                       transactionsWithCumulative[transactionsWithCumulative.length - 1].cumulativeBalance : 
                                       0;

            balanceEl.textContent = formatCurrency(finalTotalBalance);
            balanceEl.className = 'text-4xl font-bold mt-2'; // Reset classes
            balanceEl.classList.add(finalTotalBalance >= 0 ? 'balance-positive' : 'balance-negative');
            
            addDeleteListeners();
            addEditListeners(); // Adiciona os listeners de edição
            addMarkDoneListeners(); // Adiciona os listeners de marcar como feito
            addDragAndDropListeners(); // Adiciona os listeners de arrastar e soltar
        }
        
        function addDeleteListeners() {
             document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    transactionToDeleteId = Number(e.currentTarget.dataset.id);
                    confirmationModal.classList.remove('hidden');
                });
            });
        }

        function addEditListeners() {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const transactionId = Number(e.currentTarget.dataset.id);
                    const allTransactions = await getAllTransactions();
                    const transactionToEdit = allTransactions.find(t => t.id === transactionId);

                    if (transactionToEdit) {
                        editIdInput.value = transactionToEdit.id;
                        editDateInput.value = transactionToEdit.date;
                        editDescriptionInput.value = transactionToEdit.description;
                        editAmountInput.value = transactionToEdit.amount;
                        editTypeSelect.value = transactionToEdit.type;
                        editTransactionModal.classList.remove('hidden');
                    } else {
                        showCustomModal("Erro: Transação não encontrada para edição.");
                    }
                });
            });
        }

        function addMarkDoneListeners() {
            document.querySelectorAll('.mark-done-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const transactionId = Number(e.currentTarget.dataset.id);
                    await toggleDoneStatus(transactionId);
                });
            });
        }

        // Funções de arrastar e soltar
        function addDragAndDropListeners() {
            const rows = transactionList.querySelectorAll('tr[draggable="true"]');
            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            // Armazena o ID da transação no dataTransfer
            e.dataTransfer.setData('text/plain', this.dataset.id); 
            e.dataTransfer.effectAllowed = 'move';
            this.classList.add('dragging');
            draggedItem = this; // Armazena a referência para o elemento DOM para feedback visual
        }

        function handleDragOver(e) {
            e.preventDefault(); // Permite o drop
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedItem) {
                this.classList.add('bg-gray-100'); // Feedback visual para onde o item será solto
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('bg-gray-100');
        }

        async function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('bg-gray-100');

            // Obtém o ID da transação arrastada do dataTransfer
            const draggedId = Number(e.dataTransfer.getData('text/plain'));
            const targetId = Number(this.dataset.id);

            // Verifica se o ID arrastado é válido e se não estamos soltando no mesmo item
            if (draggedId && draggedId !== targetId) {
                let allTransactions = await getAllTransactions(); // Obtenha todas as transações

                const draggedTransaction = allTransactions.find(t => t.id === draggedId);
                const targetTransaction = allTransactions.find(t => t.id === targetId);

                if (!draggedTransaction) {
                    console.error("Transação arrastada não encontrada.");
                    return;
                }

                // Se houver uma transação alvo, atualiza a data da transação arrastada
                if (targetTransaction) {
                    draggedTransaction.date = targetTransaction.date;
                }
                // Se não houver alvo (ex: lista vazia), a data permanece a original

                // Remove a transação arrastada da sua posição original
                let tempTransactions = allTransactions.filter(t => t.id !== draggedId);

                // Encontra o índice da transação alvo no array filtrado
                const targetIndex = tempTransactions.findIndex(t => t.id === targetId);

                let newOrder = [];
                if (targetIndex === -1) { 
                    // Se o alvo não foi encontrado (ex: lista vazia ou erro), adiciona no final
                    newOrder = [...tempTransactions, draggedTransaction];
                } else if (e.clientY < this.getBoundingClientRect().top + this.offsetHeight / 2) {
                    // Se a posição do mouse estiver na metade superior do alvo, insere antes
                    newOrder = [
                        ...tempTransactions.slice(0, targetIndex),
                        draggedTransaction,
                        ...tempTransactions.slice(targetIndex)
                    ];
                } else {
                    // Se a posição do mouse estiver na metade inferior do alvo, insere depois
                    newOrder = [
                        ...tempTransactions.slice(0, targetIndex + 1),
                        draggedTransaction,
                        ...tempTransactions.slice(targetIndex + 1)
                    ];
                }

                // Atualiza a ordem no IndexedDB
                await updateTransactionOrder(newOrder);
            }
        }

        function handleDragEnd(e) {
            if (draggedItem) { // Garante que draggedItem não é null antes de tentar remover a classe
                draggedItem.classList.remove('dragging');
            }
            // Remove qualquer destaque de fundo que possa ter ficado
            document.querySelectorAll('#transaction-list tr').forEach(row => {
                row.classList.remove('bg-gray-100');
            });
            draggedItem = null;
        }


        // Event Listeners
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newTransaction = {
                date: form.date.value,
                description: form.description.value,
                amount: parseFloat(form.amount.value),
                type: form.type.value,
                createdAt: new Date().toISOString()
            };
            await addTransaction(newTransaction);
            form.reset();
            document.getElementById('date').valueAsDate = new Date();
            await renderUI();
        });

        cancelDeleteBtn.addEventListener('click', () => {
            transactionToDeleteId = null;
            confirmationModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (transactionToDeleteId !== null) {
                await deleteTransaction(transactionToDeleteId);
                transactionToDeleteId = null;
                confirmationModal.classList.add('hidden');
                await renderUI();
            }
        });

        // Event listeners do modal de edição
        cancelEditBtn.addEventListener('click', () => {
            editTransactionModal.classList.add('hidden');
        });

        editTransactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const updatedTransaction = {
                id: Number(editIdInput.value),
                date: editDateInput.value,
                description: editDescriptionInput.value,
                amount: parseFloat(editAmountInput.value),
                type: editTypeSelect.value,
                // Mantém o createdAt original e o isDone
                isDone: (await getAllTransactions()).find(t => t.id === Number(editIdInput.value)).isDone
            };

            await updateTransaction(updatedTransaction);
            editTransactionModal.classList.add('hidden');
            await renderUI();
            showCustomModal("Transação atualizada com sucesso!");
        });


        exportBtn.addEventListener('click', async () => {
            const transactions = await getAllTransactions();
            const dataStr = JSON.stringify(transactions, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `controle-financeiro-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });
        
        importBtn.addEventListener('click', () => {
            importFileInput.click();
        });

        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const transactions = JSON.parse(e.target.result);
                    if (Array.isArray(transactions)) {
                        // Limpa o banco de dados antes de importar
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        store.clear();
                        
                        for (const transaction of transactions) {
                            // Remove o id para que o IndexedDB possa gerar um novo
                            // e garante que 'order' e 'isDone' sejam definidos se não estiverem presentes
                            delete transaction.id; 
                            const transactionToImport = { 
                                ...transaction, 
                                order: transaction.order || Date.now(),
                                isDone: typeof transaction.isDone === 'boolean' ? transaction.isDone : false
                            };
                            await addTransaction(transactionToImport);
                        }
                        await renderUI();
                        // Substitui alert() por um modal personalizado
                        showCustomModal(`${transactions.length} transações importadas com sucesso!`);
                    } else {
                         // Substitui alert() por um modal personalizado
                        showCustomModal('Erro: O arquivo JSON não está no formato de lista esperado.');
                    }
                } catch (error) {
                    // Substitui alert() por um modal personalizado
                    showCustomModal('Erro ao ler o arquivo JSON. Verifique o formato do arquivo.');
                    console.error('Erro no import:', error);
                }
            };
            reader.readAsText(file);
            // Limpa o valor para permitir importar o mesmo arquivo novamente
            event.target.value = ''; 
        });

        // Event listener para o filtro de data
        filterDateInput.addEventListener('change', renderUI);

        // Função para exibir um modal personalizado em vez de alert()
        function showCustomModal(message) {
            const customModalHtml = `
                <div id="custom-alert-modal" class="modal-overlay">
                    <div class="modal-content shadow-xl">
                        <h3 class="text-lg font-bold mb-4">Notificação</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <button id="close-custom-alert" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">OK</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', customModalHtml);
            document.getElementById('close-custom-alert').addEventListener('click', () => {
                document.getElementById('custom-alert-modal').remove();
            });
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('date').valueAsDate = new Date();
            try {
                await initDB();
                await renderUI();
            } catch (error) {
                console.error("Não foi possível inicializar o aplicativo:", error);
                // Substitui alert() por um modal personalizado
                showCustomModal("Erro: Não foi possível carregar o banco de dados local. Tente recarregar a página.");
            }
        });
    </script>
</body>
</html>
